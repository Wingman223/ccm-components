ccm.component({name:"comment",config:{key:"comment",html:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment_html.json"],mock:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment_mock.json"],i18n:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment_i18n.json"],style:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment.css"],store:[ccm.store,{url:"ws://ccm2.inf.h-brs.de/index.js",store:"comment"}],user:[ccm.instance,"https://kaul.inf.h-brs.de/ccm/components/user2.js"]},Instance:function(){function t(t,e,n){if("string"!=typeof e&&(e+=""),n){if(!n.getPath)throw console.log(n),new Error("Context provided but without getPath?");e=this._removeLeadingSlash(e),e=e.length>0?n.getPath()+"/"+e:n.getPath()}this.model=t,this.path=e}function e(t){var e=t.target.value;n(e),i.render()}function n(t){i.i18nSave||(i.i18nSave=i.i18n),i.i18n=i.i18nSave[t],r=t}function o(){var t=navigator.language||navigator.userLanguage;return"string"==typeof t&&t.length>0?(t=t.toLowerCase(),t.indexOf("en")===-1?"deDE":"enEN"):(console.warn("Could not retrieve browser language. Falling back to deDE"),"deDE")}t.prototype.getModel=function(){return this.model},t.prototype.getPath=function(){return this.path},t.prototype.getData=function(){return this._traverse(this.getPath())},t.prototype.getProperty=function(t){return this._traverse(this.getPath()+"/"+t)},t.prototype._traverse=function(t){for(var t=this._removeLeadingSlash(t),e=t.split("/"),n=this.getModel(),o=0;o<e.length;o++){if(!n.hasOwnProperty(e[o])||!n[e[o]]){n=null;break}n=n[e[o]]}return n},t.prototype._removeLeadingSlash=function(t){return 0===t.indexOf("/")&&(t=t.substring(1,t.length)),t};var r,i=this;i.init=function(t){if(!r){var e=o();n(e)}t()},i.ready=function(t){t()},i.initDatastore=function(){i.bStoreInitialized||i.store.get(i.key,function(t){if(null===t){var e={key:i.key,data:i.mock};i.store.set(e)}i.bStoreInitialized=!0})},i.render=function(n){i.initDatastore(),ccm.helper.dataset(i,function(o){function a(t,e){var n=S(t,l("postbox"),{POSTBOX_INSERTCOMMENT:N.POSTBOX_INSERTCOMMENT,POSTBOX_SEND:N.POSTBOX_SEND,POSTBOX_USER_GUEST:N.POSTBOX_USER_GUEST,onPostboxTextareaClick:u,onPostboxButtonSubmitClick:function(t){m(t,n,e)}}),o=_(n,".textarea");return $(o).on("focusout",u),n}function c(t,e,n){var o=e.getData(),r=O(o.date),i=d(t,l("comment"),{COMMENT_BUTTON_REPLY:N.COMMENT_BUTTON_REPLY,COMMENT_BUTTON_CLOSE:N.COMMENT_BUTTON_CLOSE,name:o.guest?N.POSTBOX_USER_GUEST:o.name,date:s(r),text:o.text,onCommentButtonReplyClick:function(t){f(t,i,n)},onCommentButtonCloseClick:function(t){g(t,i,n)}});return i}function s(t){var e=new Date,n=new Date(e-t),o=n.getMinutes(),r=n.getHours()-1,a=n.getDate()-1,c=n.getMonth(),s=n.toISOString().slice(0,4)-1970,l=i.i18n,u=l.COMMENT_DATE_PREFIX+" ";if(s>0)u+=s+" "+(s>1?l.COMMENT_DATE_YEARS:l.COMMENT_DATE_YEAR);else if(c>0)u+=c+" "+(c>1?l.COMMENT_DATE_MONTHS:l.COMMENT_DATE_MONTH);else if(a>0)u+=a+" "+(a>1?l.COMMENT_DATE_DAYS:l.COMMENT_DATE_DAY);else if(r>0)u+=r+" "+(r>1?l.COMMENT_DATE_HOURS:l.COMMENT_DATE_HOUR);else{if(!(o>2))return l.COMMENT_DATE_NOW;u+=o+" "+l.COMMENT_DATE_MINUTES}return u+=" "+l.COMMENT_DATE_SUFFIX}function l(t){return i.html.component[t]}function u(t){var e=t.type;$(this).toggleClass("inputerror",!1),$(this).text(function(t,n){var o=ccm.helper.val(n)||"";switch(e){case"click":if(o===i.i18n.POSTBOX_INSERTCOMMENT)return $(this).toggleClass("placeholder",!1),"";break;case"focusout":if(0===o.length)return $(this).toggleClass("placeholder",!0),i.i18n.POSTBOX_INSERTCOMMENT}})}function f(t,e,n){h();var o=_(e,".footer");$(o).toggleClass("isreplying",!0);var r=a(o,n);Y={footer:o,postbox:r}}function g(t,e,n){h()}function h(){if(Y){var t=Y.footer,e=Y.postbox;$(t).toggleClass("isreplying",!1),e.remove(),Y=null}}function m(t,e,n){var o=_(e,".textarea"),r=_(e,":checkbox");o.text(function(t,e){var o=ccm.helper.val(e),a=1==r.prop("checked");"string"==typeof o&&o.length>2&&o!==i.i18n.POSTBOX_INSERTCOMMENT?(E(n,o,a),$(this).toggleClass("inputerror",!1)):$(this).toggleClass("inputerror",!0)})}function E(e,n,o){o||T()?i.store.get(i.key,function(r){var a=new t(r,"",e),c=a.getData(),s="";o||(s=i.user.data().name),c.unshift({name:s,guest:o,date:(new Date).toJSON(),text:n,replies:[]});for(var l=r.data.comments,u=l.length,f=0;f<l.length;f++)u+=l[f].replies.length;r.data.count=u,i.store.set(r,function(){i.render()})}):i.user.login(function(){E(e,n,o)})}function T(){return null!==i.user.data()}function O(t){return new Date(t)}function _(t,e){return M(t,e).first()}function M(t,e){return $(t).find(e)}function p(t,e,n){return v(t,"html",e,n)}function d(t,e,n){return v(t,"append",e,n)}function S(t,e,n){return v(t,"after",e,n)}function v(t,e,n,o){var r=ccm.helper.html(n,o);return $(t)[e](r),r}var C=o,N=(i.html.component,i.i18n),D=ccm.helper.element(i),P=p(D,i.html.main,{number:C.data.count,HEADER_NUM_COMMENTS:N.HEADER_NUM_COMMENTS,onLocalizationSelectionChanged:function(t){e(t)}}),y=_(P,"div"),k=_(y,"select");$(k).children("option[value="+r+"]").attr("selected","selected");for(var w=new t(C,"/data/comments"),b=(a(y,w),_(P,".comments")),x=w.getData(),A=0;A<x.length;A++){var R=new t(C,A,w),B=new t(C,"replies",R),U=c(b,R,B),I=B.getData("replies");if(I&&I.length>0)for(var X=_(U,".followup"),L=0;L<I.length;L++){var H=new t(C,L,B);c(X,H,B)}}n&&n();var Y=null})}}});