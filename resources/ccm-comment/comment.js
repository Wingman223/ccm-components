ccm.component({name:"comment",config:{key:"comment",html:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment_html.json"],mock:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment_mock.json"],i18n:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment_i18n.json"],style:[ccm.load,"http://wingman223.github.io/ccm-components/resources/ccm-comment/comment.css"],store:[ccm.store,{url:"ws://ccm2.inf.h-brs.de/index.js",store:"comment"}],user:[ccm.instance,"https://kaul.inf.h-brs.de/ccm/components/user2.js"]},Instance:function(){function t(t,e,n){"string"!=typeof e&&(e+=""),n&&(e=this._removeLeadingSlash(e),e=e.length>0?n.getPath()+"/"+e:n.getPath()),this.model=t,this.path=e}function e(t){var e=t.target.value;n(e),c.render()}function n(t){c.i18nSave||(c.i18nSave=c.i18n),c.i18n=c.i18nSave[t],r=t}function o(){return"deDE"==(navigator.language||navigator.userLanguage)?"deDE":"enEN"}t.prototype.getModel=function(){return this.model},t.prototype.getPath=function(){return this.path},t.prototype.getData=function(){return this._traverse(this.getPath())},t.prototype.getProperty=function(t){return this._traverse(this.getPath()+"/"+t)},t.prototype._traverse=function(t){for(var t=this._removeLeadingSlash(t),e=t.split("/"),n=this.getModel(),o=0;o<e.length;o++){if(!n.hasOwnProperty(e[o])||!n[e[o]]){n=null;break}n=n[e[o]]}return n},t.prototype._removeLeadingSlash=function(t){return 0===t.indexOf("/")&&(t=t.substring(1,t.length)),t};var r,c=this;c.init=function(t){function e(e){t()}if(!r){var i=o();n(i)}c.store.get(c.key,function(t){if(null===t){var n={key:c.key,data:c.mock};c.store.set(n,e)}else e(t)})},c.ready=function(t){t()},c.render=function(n){ccm.helper.dataset(c,function(o){function i(t,e){var n=d(t,u("postbox"),{POSTBOX_INSERTCOMMENT:C.POSTBOX_INSERTCOMMENT,POSTBOX_SEND:C.POSTBOX_SEND,POSTBOX_USER_GUEST:C.POSTBOX_USER_GUEST,onPostboxTextareaClick:l,onPostboxButtonSubmitClick:function(t){h(t,n,e)}}),o=O(n,".textarea");return $(o).on("focusout",l),n}function a(t,e,n){var o=e.getData(),r=p(o.date),c=S(t,u("comment"),{COMMENT_BUTTON_REPLY:C.COMMENT_BUTTON_REPLY,COMMENT_BUTTON_CLOSE:C.COMMENT_BUTTON_CLOSE,name:o.guest?C.POSTBOX_USER_GUEST:o.name,date:s(r),text:o.text,onCommentButtonReplyClick:function(t){m(t,c,n)},onCommentButtonCloseClick:function(t){f(t,c,n)}});return c}function s(t){var e=new Date,n=new Date(e-t),o=n.getMinutes(),r=n.getHours()-1,i=n.getDate()-1,a=n.getMonth()-1,s=n.toISOString().slice(0,4)-1970,u=c.i18n,l=u.COMMENT_DATE_PREFIX+" ";if(s>0)l+=s+" "+(s>1?u.COMMENT_DATE_YEARS:u.COMMENT_DATE_YEAR);else if(a>0)l+=a+" "+(a>1?u.COMMENT_DATE_MONTHS:u.COMMENT_DATE_MONTH);else if(i>0)l+=i+" "+(i>1?u.COMMENT_DATE_DAYS:u.COMMENT_DATE_DAY);else if(r>0)l+=r+" "+(r>1?u.COMMENT_DATE_HOURS:u.COMMENT_DATE_HOUR);else{if(!(o>2))return u.COMMENT_DATE_NOW;l+=o+" "+u.COMMENT_DATE_HOURS}return l+=" "+u.COMMENT_DATE_SUFFIX}function u(t){return c.html.component[t]}function l(t){var e=t.type;$(this).toggleClass("inputerror",!1),$(this).text(function(t,n){var o=ccm.helper.val(n)||"";switch(e){case"click":if(o===c.i18n.POSTBOX_INSERTCOMMENT)return $(this).toggleClass("placeholder",!1),"";break;case"focusout":if(0===o.length)return $(this).toggleClass("placeholder",!0),c.i18n.POSTBOX_INSERTCOMMENT}})}function m(t,e,n){g();var o=O(e,".footer");$(o).toggleClass("isreplying",!0);var r=i(o,n);Y={footer:o,postbox:r}}function f(t,e,n){g()}function g(){if(Y){var t=Y.footer,e=Y.postbox;$(t).toggleClass("isreplying",!1),e.remove(),Y=null}}function h(t,e,n){var o=O(e,".textarea"),r=O(e,":checkbox");o.text(function(t,e){var o=ccm.helper.val(e),i=1==r.prop("checked");"string"==typeof o&&o.length>2&&o!==c.i18n.POSTBOX_INSERTCOMMENT?(T(n,o,i),$(this).toggleClass("inputerror",!1)):$(this).toggleClass("inputerror",!0)})}function T(e,n,o){o||E()?c.store.get(c.key,function(r){var i=new t(r,"",e),a=i.getData(),s="";o||(s=c.user.data().name),a.unshift({name:s,guest:o,date:(new Date).toJSON(),text:n,replies:[]});for(var u=r.data.comments,l=u.length,m=0;m<u.length;m++)l+=u[m].replies.length;r.data.count=l,c.store.set(r,function(){c.render()})}):c.user.login(function(){T(n,o)})}function E(){return null!==c.user.data()}function p(t){return new Date(t)}function O(t,e){return _(t,e).first()}function _(t,e){return $(t).find(e)}function M(t,e,n){return v(t,"html",e,n)}function S(t,e,n){return v(t,"append",e,n)}function d(t,e,n){return v(t,"after",e,n)}function v(t,e,n,o){var r=ccm.helper.html(n,o);return $(t)[e](r),r}var N=o,C=(c.html.component,c.i18n),D=ccm.helper.element(c),P=M(D,c.html.main,{number:N.data.count,HEADER_NUM_COMMENTS:C.HEADER_NUM_COMMENTS,onLocalizationSelectionChanged:function(t){e(t)}}),y=O(P,"div"),R=O(y,"select");$(R).children("option[value="+r+"]").attr("selected","selected");for(var k=new t(N,"/data/comments"),A=(i(y,k),O(P,".comments")),b=k.getData(),w=0;w<b.length;w++){var B=new t(N,w,k),x=new t(N,"replies",B),U=a(A,B,x),X=x.getData("replies");if(X&&X.length>0)for(var I=O(U,".followup"),L=0;L<X.length;L++){var H=new t(N,L,x);a(I,H,x)}}n&&n();var Y=null})}}});